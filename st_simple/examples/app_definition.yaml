name: "Enterprise Dashboard"
description: "A comprehensive dashboard showcasing advanced event-driven architecture"
standard: "common-streamlit"

session:
 user_id:
   initial_state: "anonymous"
   type: "str"
   strict: true
 
 selected_department:
   initial_state: "all"
   type: "str" 
   strict: true
   
 sales_data:
   initial_state: []
   type: "list"
   strict: false
   deserialize: true
   engine: "json"
   
 filter_cache:
   initial_state: {}
   type: "dict"
   strict: false
   
 dashboard_state:
   initial_state: "loading"
   type: "str"
   strict: true

elements:
 save_button:
   type: "button"
   label: "üíæ Save Changes"
   help: "Save all pending changes"
   key: "save_btn"
   on_click: "save_all_data"
   
 refresh_button:
   type: "button" 
   label: "üîÑ Refresh"
   key: "refresh_btn"
   on_click: "refresh_dashboard"
   
 status_indicator:
   type: "write"
   content: "System Status: Loading..."
   
 error_display:
   type: "error"
   content: "Something went wrong!"
   
 success_message:
   type: "success"
   content: "Data saved successfully!"

main:
 st_title:
   args: "üè¢ Enterprise Dashboard"
   
 st_caption:
   args: "Real-time business intelligence with event-driven architecture"
   unsafe_allow_html: true
   
 # Header controls with broadcast example
 st_container:
   elements:
     - st_selectbox:
         label: "Department Filter"
         options: ["all", "sales", "marketing", "engineering", "finance"]
         key: "dept_filter"
         on_change: "filter_department"
         inherit_value: true  # Handler gets selected value
         
     - element:
         name: "refresh_button"
         
     - element:
         name: "save_button"
   border: true
   order: "sequential"
   
 # Multi-column layout with complex interactions  
 st_columns:
   elements:
     # Left column - Filters and controls
     - st_container:
         elements:
           - st_subheader:
               args: "Filters & Controls"
               
           - st_date_input:
               label: "Date Range"
               key: "date_range"
               on_change: "update_date_filter"
               inherit_value: true
               
           - st_multiselect:
               label: "Metrics to Display"
               options: ["revenue", "users", "conversion", "churn"]
               default: ["revenue", "users"]
               key: "metrics_selector"
               on_change: "update_metrics"
               inherit_value: true
               
           - st_slider:
               label: "Refresh Interval (seconds)"
               min_value: 5
               max_value: 300
               value: 30
               key: "refresh_interval"
               on_change: "update_refresh_rate"
               inherit_value: true
               
           - st_button:
               label: "üö® Emergency Reset"
               key: "emergency_reset"
               on_click: "emergency_reset_handler"
               help: "Broadcasts reset signal to all components"
               
     # Right column - Data visualization
     - st_container:
         elements:
           - st_subheader:
               args: "Key Metrics"
               
           - element:
               name: "status_indicator"
               
           - st_plotly_chart:
               key: "main_chart"
               config:
                 displayModeBar: false
               use_container_width: true
               
           - st_dataframe:
               key: "metrics_table" 
               use_container_width: true
               on_select: "row_selected"
               inherit_value: true
               selection_mode: "multi-row"
               
   size: 2
   gap: "large"
   order: [1, 2]
   
 # Expandable sections with conditional rendering
 st_expander:
   label: "üîç Advanced Analytics"
   expanded: false
   elements:
     - st_tabs:
         tabs: ["Trends", "Forecasts", "Anomalies"]
         elements:
           # Trends tab
           - st_container:
               elements:
                 - st_line_chart:
                     key: "trends_chart"
                     
                 - st_button:
                     label: "Export Trends"
                     key: "export_trends" 
                     on_click: "export_data"
                     
           # Forecasts tab  
           - st_container:
               elements:
                 - st_area_chart:
                     key: "forecast_chart"
                     
                 - st_selectbox:
                     label: "Forecast Model"
                     options: ["linear", "exponential", "seasonal"]
                     key: "forecast_model"
                     on_change: "update_forecast_model"
                     inherit_value: true
                     
           # Anomalies tab
           - st_container:
               elements:
                 - st_scatter_chart:
                     key: "anomaly_chart"
                     
                 - st_number_input:
                     label: "Sensitivity Threshold"
                     min_value: 0.1
                     max_value: 3.0
                     value: 2.0
                     step: 0.1
                     key: "anomaly_threshold"
                     on_change: "update_anomaly_detection"
                     inherit_value: true
                     
 # Action buttons with handler composition
 st_container:
   elements:
     - st_columns:
         elements:
           - element:
               name: "save_button"
               
           - st_button:
               label: "üìß Send Report"
               key: "send_report"
               on_click: "generate_and_send_report"
               
           - st_button:
               label: "‚öôÔ∏è Recalculate All"
               key: "recalculate"
               on_click: "recalculate_metrics"
               
         size: 3
         gap: "small"
         
     # Status messages (conditionally rendered)
     - element:
         name: "error_display"
         conditional: "show_error"  # Only show if session state show_error is true
         
     - element:
         name: "success_message" 
         conditional: "show_success"
         
   border: true
   
# Fragment for real-time updates
fragments:
 realtime_updates:
   run_every: "30s"
   elements:
     - st_metric:
         label: "Live Users"
         value: "session:live_users"  # Reference session state
         key: "live_users_metric"
         
     - st_metric:
         label: "System Health"
         value: "session:system_health"
         key: "health_metric"
   on_render: "update_realtime_data"  # Called every 30s

# Event handlers configuration
handlers:
 filter_department:
   blacklist: ["internal_state"]  # Don't send internal state to handler
   
 save_all_data:
   publishes_to: ["validate_data", "backup_data"]  # Handler composition
   
 emergency_reset_handler:
   broadcasts: true  # Sends to ALL handlers
   
 recalculate_metrics:
   publishes_to: ["update_charts", "refresh_tables", "clear_cache"]
   
 generate_and_send_report:
   publishes_to: ["generate_report"]
   async: false  # Explicit async control